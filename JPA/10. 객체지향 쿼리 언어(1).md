# ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´

## ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì†Œê°œ

+ ê°€ì¥ ë‹¨ìˆœí•œ ê²€ìƒ‰ ë°©ë²•
  + ì‹ë³„ìë¡œ ì¡°íšŒ `EntityManager.find()`
  + ê°ì²´ ê·¸ë˜í”„ íƒìƒ‰ (ì˜ˆ: `a.getB().getC()`)

+ í˜„ì‹¤ì ì´ê³  ë³µì¡í•œ ê²€ìƒ‰
  + SQLë¡œ í•„ìš”í•œ ë‚´ìš©ì„ ìµœëŒ€í•œ ê±¸ëŸ¬ì„œ ì¡°íšŒ -> ORMì„ ì‚¬ìš©í•˜ë©´ ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ê¸°ì— ì—”í‹°í‹° ê°ì²´ ëŒ€ìƒì˜ ë°©ë²•ì´ í•„ìš”
  + **JPQL**
    + í…Œì´ë¸”ì´ ì•„ë‹Œ **ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ê²€ìƒ‰í•˜ëŠ” ê°ì²´ì§€í–¥ ì¿¼ë¦¬**
    + SQLì„ ì¶”ìƒí™”í•´ì„œ **íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ SQLì˜ ì˜ì¡´í•˜ì§€ ì•ŠìŒ** (ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ ê°€ëŠ¥)



ğŸ“ŒJPAëŠ” ë‹¤ì–‘í•œ ê²€ìƒ‰ ë°©ë²•ì„ ì œê³µ, JPAê°€ ê³µì‹ ì§€ì›í•˜ëŠ” ê¸°ëŠ¥

- `JPQL (Java Persistence Query Language)`

- `Criteria ì¿¼ë¦¬ (Criteria Query)` : JPQLì„ í¸í•˜ê²Œ ì‘ì„±í•˜ë„ë¡ ë„ì™€ì£¼ëŠ” API

- `ë„¤ì´í‹°ë¸Œ SQL (Native SQL)` : JPQLëŒ€ì‹  ì§ì ‘ SQL ì‚¬ìš©

- `QueryDSL` : Criteria ì¿¼ë¦¬ì²˜ëŸ¼ JPQLì„ ë„ì™€ì£¼ëŠ” ë¹Œë” í´ë˜ìŠ¤, ë¹„í‘œì¤€ ì˜¤í”ˆì†ŒìŠ¤ í”„ë ˆì„ì›Œí¬

- `JDBC`, `MyBatis ê°™ì€ SQL ë§¤í¼ í”„ë ˆì„ì›Œí¬` ì‚¬ìš©



### JPQL

- JPQLì€ ì—”í‹°í‹° ê°ì²´ë¥¼ ì¡°íšŒí•˜ëŠ” ê°ì²´ì§€í–¥ ì¿¼ë¦¬

- ë¬¸ë²•ì€ SQLê³¼ ë¹„ìŠ·, ANSI í‘œì¤€ SQLì´ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì„ ìœ ì‚¬í•˜ê²Œ ì§€ì›

- JPQLì€ SQLì„ ì¶”ìƒí™”í•´ì„œ íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ (ë°©ì–¸(`Dialect`) ì‚¬ìš©)

- JPQLì€ SQLë³´ë‹¤ ê°„ê²°, ì—”í‹°í‹° ì§ì ‘ ì¡°íšŒ, ë¬µì‹œì  ì¡°ì¸, ë‹¤í˜•ì„± ì§€ì›



```java
//íšŒì› ì—”í‹°í‹°
@Entity(name = "Member") //name ì†ì„±ì˜ ê¸°ë³¸ê°’ì€ í´ë˜ìŠ¤ëª…
public class Member{
	@Column(name = "name")
	private String username;
	
	...
}

//JPQL ì‚¬ìš©
String jpql = "select m from Member as m where m.username = 'kim'";
List<Member> resultList = em.createQuery(jpql, Member.class).getResultList();

//ì‹¤ì œ ì‹¤í–‰ëœ SQL
select
		member.id as id,
		member.age as age,
		member.team_id as team,
		member.name as name
from Member member
where
		member.name = 'kim'
```



### Criteria ì¿¼ë¦¬ ì†Œê°œ

- CriteriaëŠ” JPQLì„ ìƒì„±í•˜ëŠ” ë¹Œë” í´ë˜ìŠ¤

- ë¬¸ìê°€ ì•„ë‹Œ `query.select(m).where(...)`ì²˜ëŸ¼ í”„ë¡œê·¸ë˜ë° ì½”ë“œë¡œ JPQLì„ ì‘ì„±

- JPQLì€ ì˜¤íƒ€ê°€ ìˆì–´ë„ ëŸ°íƒ€ì„ ì‹œì ì— ì˜¤ë¥˜ê°€ ë°œìƒ, CriteriaëŠ” ì´ëŸ° ë‹¨ì ì„ ì»´íŒŒì¼ì‹œ ë°œê²¬ ê°€ëŠ¥

- Criteriaì˜ ì¥ì 

  - ì»´íŒŒì¼ ì‹œì ì— ì˜¤ë¥˜ ë°œê²¬ ê°€ëŠ¥

  - IDEë¥¼ ì‚¬ìš©í•˜ë©´ ì½”ë“œ ìë™ì™„ì„±ì„ ì§€ì›

  - ë™ì  ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ê¸° í¸ë¦¬

```java
//JPQL
select m from Member as m where m.username = 'kim'

//Criteria ì‚¬ìš© ì¤€ë¹„
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Member> query = cb.createQuery(Member.class);

//ë£¨íŠ¸ í´ë˜ìŠ¤(ì¡°íšŒë¥¼ ì‹œì‘í•  í´ë˜ìŠ¤)
Root<Member> m = query.from(Member.class);

//ì»¤ë¦¬ ìƒì„±
CriteriaQuery<Member> cq = query.select(m).where(cb.equal(m.get("username"), "kim"));
List<Member> resultList = em.createQuery(cq).getResultList();
```

- "username"ì˜ ë¬¸ìë¥¼ ì½”ë“œë¡œ ì‘ì„±í•˜ê³  ì‹¶ìœ¼ë©´ ë©”íƒ€ ëª¨ë¸ì„ ì‚¬ìš©

  - ë©”íƒ€ ëª¨ë¸ APIëŠ” ì–´ë…¸í…Œì´ì…˜ í”„ë¡œì„¸ì„œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ Criteria ì „ìš© í´ë˜ìŠ¤ë¥¼ ìƒì„±

  - m.get("username") â†’ m.get(Member_.username)ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥

- CriteriaëŠ” ì¥ì ë„ ë§ì§€ë§Œ **ë³µì¡í•˜ê³  ì¥í™©í•˜ì—¬ ì‘ì„±í•œ ì½”ë“œë„ í•œëˆˆì— ë“¤ì–´ì˜¤ì§€ì•ŠëŠ” í° ë‹¨ì **



### QueryDSL ì†Œê°œ

- QueryDSLë„ JQPL ë¹Œë” ì—­í• 

- ì½”ë“œ ê¸°ë°˜ì´ë©´ì„œ ë‹¨ìˆœí•˜ê³  ì‚¬ìš©í•˜ê¸° ì‰½ë‹¤ëŠ” ì¥ì 

- QueryDSLì€ JPA í‘œì¤€ì€ ì•„ë‹ˆê³  ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ JPAë¿ ì•„ë‹ˆë¼ JDO, ëª½ê³ DB, Java Collection ë“± ê±°ì˜ ê°™ì€ ë¬¸ë²•ìœ¼ë¡œ ì§€ì›

```java
//ì¤€ë¹„
JPAQuery query = new JPAQuery(em);
QMember member = QMember.member;

//ì¿¼ë¦¬, ê²°ê³¼ ì¡°íšŒ
List<Member> members = 
		query.from(member)
		.where(member.username.eq("kim"))
		.list(member);
```



### ë„¤ì´í‹°ë¸Œ SQL ì†Œê°œ

- SQLì„ ì§ì ‘ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥

- íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ì—ì„œë§Œ ë™ì‘í•˜ëŠ” SQLì„ ì‚¬ìš©í•  ë•Œ ì£¼ë¡œ ì‚¬ìš© (`ì˜¤ë¼í´ CONNECT BY`)

- íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ì— ì˜ì¡´í•˜ëŠ” SQLì„ ì‘ì„±í•˜ëŠ” ë‹¨ì ì´ ë°œìƒ (ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ì‹œ ìˆ˜ì • í•„ìš”)

```java
String sql = "SELECT ID, AGE, TEAM_ID, NAME FROM MEMBER WHERE NAME = 'kim'";
List<Member> resultList = em.createNativeQuery(sql, Member.class).getResultList();
```



### JDBC ì§ì ‘ ì‚¬ìš©, ë§ˆì´ë°”í‹°ìŠ¤ ê°™ì€ SQL ë§¤í¼ í”„ë ˆì„ì›Œí¬ ì‚¬ìš©

+ í•˜ì´ë²„ë„¤ì´íŠ¸ì—ì„œ JDBC ì»¤ë„¥ì…˜ì„ ì§ì ‘ ì ‘ê·¼í•˜ë ¤ë©´ JPA êµ¬í˜„ì²´ê°€ ì œê³µí•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©

```java
Session session = entityManager.unwrap(Session.class);
session.doWork(new Work() {
		@Override
		public void execute(Connection connection) throws SQLException {
				//work...
		}
});
```

- JDBC, ë§ˆì´ë°”í‹°ìŠ¤ë¥¼ JPAì™€ í•¨ê»˜ ì“°ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì ì ˆí•œ ì‹œê¸°ì— ê°•ì œ í”ŒëŸ¬ì‹œê°€ í•„ìš”

  - JDBC, SQL ë§¤í¼ëŠ” **JPAë¥¼ ìš°íšŒí•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼, JPAëŠ” ì¸ì§€í•˜ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒ**

  - **JPAë¥¼ ìš°íšŒí•´ì„œ SQLì„ ì‹¤í–‰í•˜ê¸° ì „ ìˆ˜ë™ìœ¼ë¡œ í”ŒëŸ¬ì‹œí•´ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë™ê¸°í™”ê°€ í•„ìš”**

- ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ì— AOPë¥¼ í†µí•´ ìš°íšŒì ‘ê·¼ì‹œ í”ŒëŸ¬ì‹œí•˜ë©´ ë¬¸ì œë¥¼ ê¹”ë”íˆ í•´ê²° ê°€ëŠ¥





## JPQL

### JPQLì˜ íŠ¹ì§•

- ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´, ë°ì´í„°ë² ì´ìŠ¤ì˜ í…Œì´ë¸”ì„ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ê°ì²´ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬

- SQLì„ ì¶”ìƒí™”í•´ì„œ íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ SQLì— ì˜ì¡´ì ì´ì§€ ì•ŠìŒ

- **ê²°êµ­ JPQLì€ ë§ˆì§€ë§‰ì—” SQLë¡œ ë³€í™˜**

<img src="https://user-images.githubusercontent.com/101400894/178414036-a6613964-576d-436b-884d-e30c4a90a758.png" alt="image" style="zoom:40%;" align="left"/>



### ê¸°ë³¸ ë¬¸ë²•ê³¼ ì¿¼ë¦¬ API

JPQLë„ SELECT, UPDATE, DELETEë¬¸ ì‚¬ìš© ê°€ëŠ¥

- ì—”í‹°í‹°ë¥¼ ì €ì¥í• ë•ŒëŠ” `EntityManager.persist()` ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ INSERTë¬¸ì€ ì—†ìŒ

```java
select_ë¬¸ :: =
		select_ì ˆ
		from_ì ˆ
		[where_ì ˆ]
		[groupby_ì ˆ]
		[having_ì ˆ]
		[orderby_ì ˆ]

update_ë¬¸ :: = update_ì ˆ [where_ì ˆ]
delete_ë¬¸ :: = delete_ì ˆ [where_ì ˆ]
```



#### SELECT ë¬¸

> SELECT ê¸°ë³¸ ì‚¬ìš©

```
SELECT ë³„ì¹­ FROM ì—”í‹°í‹°ì´ë¦„ AS ë³„ì¹­

SELECT m FROM Member AS m where m.username = 'Hello'
```

**ëŒ€ì†Œë¬¸ì êµ¬ë¶„**

- ì—”í‹°í‹°ì™€ ì†ì„±ì€ ëŒ€ì†Œë¬¸ìë¥¼ êµ¬ë¶„ (Member, username) 
- JPQL í‚¤ì›Œë“œëŠ” ëŒ€ì†Œë¬¸ì êµ¬ë¶„í•˜ì§€ ì•ŠìŒ (SELECT, FROM, AS)



**ì—”í‹°í‹° ì´ë¦„**

- MemberëŠ” í´ë˜ìŠ¤ ëª…ì´ ì•„ë‹ˆë¼ ì—”í‹°í‹°ëª… ( `@Entity(name="xxx")`ë¡œ ì§€ì • ê°€ëŠ¥ )

- ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ í´ë˜ìŠ¤ëª…ì´ ê¸°ë³¸ê°’, í´ë˜ìŠ¤ ëª…ì„ ì—”í‹°í‹°ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì¶”ì²œ



**ë³„ì¹­(ì‹ë³„ ë³€ìˆ˜)ì€ í•„ìˆ˜**

- JPQLì€ Member AS mê³¼ ê°™ì€ **ë³„ì¹­ì€ í•„ìˆ˜**, ë³„ì¹­ì´ ì—†ëŠ” ê²½ìš° ì˜¤ë¥˜ ë°œìƒ, ASëŠ” ìƒëµ ê°€ëŠ¥

```
SELECT username FROM member m //ì˜ëª»ëœ ë¬¸ë²•, username -> m.usernameìœ¼ë¡œ ìˆ˜ì • í•„ìš”)
```

- í•˜ì´ë²„ë„¤ì´íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©´ HQLë„ ì‚¬ìš© ê°€ëŠ¥ HQLì€ ë³„ì¹­ ì—†ì´ ì‚¬ìš©ì´ ê°€ëŠ¥ (JPQL X)



#### TypeQuery, Query

> ì‘ì„±í•œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ ì¿¼ë¦¬ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì•¼ í•¨

- ì¿¼ë¦¬ ê°ì²´ëŠ” TypeQueryì™€ Queryê°€ ì¡´ì¬
  - ë°˜í™˜í•  íƒ€ì…ì„ ëª…í™•í•˜ê²Œ ì§€ì •ì´ ê°€ëŠ¥í•˜ë©´ `TypeQuery`, ëª…í™•í•˜ì§€ ì•Šìœ¼ë©´ `Query`**ì‚¬ìš©**

```java
//TypeQuery ì‚¬ìš©
TypeQuery<Member> query = em.createQuery("SELECT m FROM Member m", Member.class); //(ì¿¼ë¦¬ë¬¸ ,ë°˜í™˜íƒ€ì…)

List<Member> resultList = query.getResultList();
for (Member member : resultList) {
		System.out.println("member = " + member);
}
```

```java
//Query ì‚¬ìš©
Query query = em.createQuery("SELECT m.username, m.age from Member m");

List resultList = query.getResultList();
for (Object o : resultList) {
		Object[] result = (Object[]) o; //ê²°ê³¼ê°€ ë‘˜ ì´ìƒì´ë¼ ë°°ì—´
		System.out.println("username = " + result[0]);
		System.out.println("age = " + result[1]);
}
```

+ íƒ€ì…ì„ ë³€í™˜í•  í•„ìš”ê°€ ì—†ëŠ” TypeQueryë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” í¸ë¦¬



#### ê²°ê³¼ ì¡°íšŒ

ì‹¤ì œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°íšŒí•˜ëŠ” ë©”ì†Œë“œ 2ê°€ì§€

- `query.getResultList()` : ê²°ê³¼ë¥¼ List ì»¬ë ‰ì…˜ìœ¼ë¡œ ë°˜í™˜, ë§Œì•½ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë¹ˆ ì»¬ë ‰ì…˜ì„ ë°˜í™˜

- `query.getSingleResult()`: ê²°ê³¼ê°€ ì •í™•íˆ í•˜ë‚˜ì¼ ë•Œ ì‚¬ìš©(1ê°œê°€ ì•„ë‹ ê²½ìš° ì˜ˆì™¸ ë°œìƒ)

  - ê²°ê³¼ê°€ ì—†ìœ¼ë©´ `javax.persistence.NoResultException` ì˜ˆì™¸ ë°œìƒ

  - ê²°ê³¼ê°€ 1ê°œë³´ë‹¤ ë§ìœ¼ë©´ `javax.persistence.NonUniqueResultException` ì˜ˆì™¸ ë°œìƒ

-----------------

### íŒŒë¼ë¯¸í„° ë°”ì¸ë”©

- JPQLì€ `ì´ë¦„ ê¸°ì¤€`, `ìœ„ì¹˜ ê¸°ì¤€` íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ ì§€ì›



#### **ì´ë¦„ ê¸°ì¤€ íŒŒë¼ë¯¸í„°**

- ì´ë¦„ìœ¼ë¡œ êµ¬ë¶„í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ **ì´ë¦„ ê¸°ì¤€ íŒŒë¼ë¯¸í„°ëŠ” ì•ì— :**ë¥¼ ì‚¬ìš©

```java
String usernameParam = "User1";

//ê¸°ë³¸ ë°©ë²•
TypeQuery<Member> query = 
		em.createQuery("SELECT m FROM Member m where m.username = :username", Member.class);
																  //:username -> usernameì´ íŒŒë¼ë¯¸í„°
query.setParameter("username", usernameParam); //: í‘œì‹œëœ usernameì„ usernameParamìœ¼ë¡œ ì„¸íŒ…
List<Member> resultList = query.getResultList();

//ì²´ì¸ ë°©ì‹ ë°©ë²•
List<Member> members = 
		em.createQuery("SELECT m FROM Member m where m.username = :username", Member.class)
		.setParameter("username", usernameParam)
		.getResultList();
```



#### **ìœ„ì¹˜ ê¸°ì¤€ íŒŒë¼ë¯¸í„°**

- ìœ„ì¹˜ ê¸°ì¤€íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ? ë‹¤ìŒì— ìœ„ì¹˜ ê°’ì„ ì§€ì •

```java
//ì²´ì¸ ë°©ì‹ ë°©ë²•
List<Member> members = 
		em.createQuery("SELECT m FROM Member m where m.username = ?1", Member.class)
		.setParameter(1, usernameParam)
		.getResultList();
```

- **ì´ë¦„ ê¸°ì¤€ íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ë°©ì‹ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ëª…í™•**

- íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ë°©ì‹ì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ SQL ì¸ì ì…˜ ê³µê²©ê³¼ ì„±ëŠ¥ì´ìŠˆê°€ ë°œìƒ JPAëŠ” JPQLì„ SQLì˜ íŒŒì‹±ê²°ê³¼ë¥¼ ì¬ì‚¬ìš©í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒ, **íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì€ ì„ íƒì´ ì•„ë‹Œ í•„ìˆ˜**

```
//ìœ„í—˜í•œ ì½”ë“œ (SQLì¸ì ì…˜ ê³µê²©ê³¼ ì„±ëŠ¥ì´ìŠˆ ë°œìƒ)
"select m from Member m where m.username = '" + usernameParam + "'"
```

-----

### í”„ë¡œì ì…˜

> SELECT ì ˆì— ì¡°íšŒí•  ëŒ€ìƒì„ ì§€ì •í•˜ëŠ” ê²ƒì„ í”„ë¡œì ì…˜(projection)

- í”„ë¡œì ì…˜ ëŒ€ìƒì€ ì—”í‹°í‹°, ì— ë² ë””ë“œ íƒ€ì…, ìŠ¤ì¹¼ë¼ íƒ€ì…[ìˆ«ì, ë¬¸ì ë“± ê¸°ë³¸ ë°ì´í„° íƒ€ì…ì„ ì˜ë¯¸]



**ì—”í‹°í‹° í”„ë¡œì ì…˜**

- ì—”í‹°í‹°ë¥¼ í”„ë¡œì ì…˜ ëŒ€ìƒìœ¼ë¡œ ì‚¬ìš©, ì´ë ‡ê²Œ ì¡°íšŒí•œ ì—”í‹°í‹°ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬

```
SELECT m FROM Member m //íšŒì›
SELECT m.team FROM Member m //íŒ€
```



**ì„ë² ë””ë“œ íƒ€ì… í”„ë¡œì ì…˜**

- ì„ë² ë””ë“œ íƒ€ì…ì€ ì—”í‹°í‹°ì™€ ê±°ì˜ ë¹„ìŠ·í•˜ê²Œ ì‚¬ìš©ë˜ì§€ë§Œ **ì¡°íšŒ ì‹œì‘ì ì´ ë  ìˆ˜ ì—†ë‹¤**ëŠ” ì œì•½ì´ ì°¨ì´

  ```
  //ì˜ëª»ëœ ì¿¼ë¦¬
  String query = "SELECT a FROM Address a";
  
  //ì •ìƒì ì¸ ì¿¼ë¦¬
  String query = "SELECT o.address FROM Order o";
  List<Address> addresses = em.createQuery(query, Address.class).getResultList();
  ```

- ì„ë² ë””ë“œ íƒ€ì…ì€ ì—”í‹°í‹°íƒ€ì…ì´ ì•„ë‹Œ ê°’ íƒ€ì…, ì„ë² ë””ë“œ íƒ€ì…ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬X



**ìŠ¤ì¹¼ë¼ íƒ€ì… í”„ë¡œì ì…˜**

- ìˆ«ì, ë¬¸ì, ë‚ ì§œì™€ ê°™ì€ ê¸°ë³¸ ë°ì´í„° íƒ€ì…ë“¤ì´ ìŠ¤ì¹¼ë¼ íƒ€ì…

  ```
  List<String> usernames = 
  		em.createQuery("SELECT username FROM Member m", String.class)
  			.getResultList();
  
  Double orderAmountAvg = 
  		em.createQuery("SELECT AVG(o.orderAmount) FROM Order o", Double.class)
  			.getSingleResult()
  ```



**ì—¬ëŸ¬ ê°’ ì¡°íšŒ**

- ì—”í‹°í‹° ëŒ€ìƒì´ ì•„ë‹Œ ê¼­ í•„ìš”í•œ ë°ì´í„°ë“¤ë§Œ ì„ íƒí•´ì„œ ì¡°íšŒí•  ë•Œ ì‚¬ìš©

  ```
  List<Object[]> resultList = 
  		em.createQuery("SELECT o.member, o.product, o.orderAmount FROM Order o")
  				.getResultList();
  
  for (Object[] row : resultList) {
  		Member member = (Member) row[0];     //ì—”í‹°í‹°
  		Product product = (Product) row[1];  //ì—”í‹°í‹°
  		int orderAmount = (Integer) row[2];  //ìŠ¤ì¹¼ë¼
  }
  ```

  - ì¡°íšŒí•œ ì—”í‹°í‹°ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ê´€ë¦¬



**NEW ëª…ë ¹ì–´**

- ì‹¤ë¬´ì—ì„œëŠ” Object[]ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šê³  **DTO**ë¥¼ ë§Œë“¤ì–´ ê°ì²´ë¡œ ë°˜í™˜í•´ì„œ ì‚¬ìš©

  ```java
  public class UserDTO {
  		private String username;
  		private int age;
  		
  		public UserDTO(String username, int age) {
  				this.username = username;
  				this.age = age;
  		}
  		...
  }
  ```

  ```java
  //-------------1. DTOë¥¼ ì‚¬ìš©í•´ì„œ ì»¬ë ‰ì…˜ì— ì €ì¥ í›„ ë¦¬í„´-------------
  List<Object[]> resultList = 
  		em.createQuery("SELECT m.username, m.age FROM Member m")
  				.getResultList();
  
  List<UserDTO> userDTOs = new ArrayList<UserDTO>();
  for (Object[] row : resultList) {
  		UserDTO userDTO = new UserDTO((String)row[0], (Integer)row[1]);
  		userDTOs.add(userDTO);
  }
  return userDTOs;
  
  
  //-------------2. new ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì €ì¥ í›„ ë¦¬í„´-------------
  TypeQuery<UserDTO> query = 
  		em.createQuery("SELECT new jpabook.jpql.UserDTO(m.username, m.age) FROM Member m");
  
  List<UserDTO> resultList = query.getResultList();
  return resultList;
  ```

  - 1ë²ˆì—ì„œ new ëª…ë ¹ì–´ë¥¼ í†µí•´ ë³€í™˜í•˜ë¯€ë¡œ ì§€ë£¨í•œ ë³€í™˜ì‘ì—…ì„ í•˜ì§€ ì•Šì•„ë„ ë™ì¼ ê²°ê³¼ê°€ ë¦¬í„´

- NEW ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ë–„ ì£¼ì˜í•´ì•¼ í•  2ê°€ì§€

  1. **íŒ¨í‚¤ì§€ ëª…ì„ í¬í•¨í•œ ì „ì²´ í´ë ˆìŠ¤ ëª…ì„ ì…ë ¥ (`jpabook.jpql.UserDTO`)**

  2. **ìˆœì„œì™€ íƒ€ì…ì´ ì¼ì¹˜**í•˜ëŠ” ìƒì„±ìê°€ í•„ìš”( `UserDTO(m.username, m.age)` )

------

### í˜ì´ì§• API

> í˜ì´ì§• ì²˜ë¦¬ìš© SQLì€ ì§€ë£¨í•˜ê³  ë°˜ë³µì ì¸ ì¼ì´ë©°, ë°ì´í„°ë² ì´ìŠ¤ë§ˆë‹¤ í˜ì´ì§• ì²˜ë¦¬ ë¬¸ë²•ì´ ë‹¤ë¦„

- JPAëŠ” í˜ì´ì§•ì„ ë‘ APIë¡œ ì¶”ìƒí™” ì²˜ë¦¬

  - `setFirstResult(int startPosition)` : ì¡°íšŒ ì‹œì‘ ìœ„ì¹˜(0ë¶€í„° ì‹œì‘)

  - `setMaxResults(int maxResult)` : ì¡°íšŒí•  ë°ì´í„° ìˆ˜

  ```
  TypeQuery<Member> query = 
  		em.createQuery("SELECT m FROM Member m ORDER BY m.username DESC", Member.class);
  
  query.setFirstResult(10);
  query.setMaxResults(20);
  query.getResultList();
  ```

  - `FirstResult` ì‹œì‘ì´ 10ì´ë¯€ë¡œ 11ë¶€í„° ì‹œì‘í•´ì„œ 20ê±´ì„ ì¡°íšŒ (11~30ë²ˆ ë°ì´í„° ì¡°íšŒ)

- ë°ì´í„° ë² ì´ìŠ¤ ë°©ì–¸(Dialect) ë•ë¶„ì— ê°™ì€ APIë¡œ ì²˜ë¦¬ ê°€ëŠ¥



#### JPA(Dialect) í˜ì´ì§• API ë°ì´í„°ë² ì´ìŠ¤ë³„ ì¿¼ë¦¬

> HSQLDB

```
SELECT
		M.ID AS ID,
		M.AGE AS AGE,
		M.TEAM_ID AS TEAM_ID,
		M.NAME AS NAME
FROM
		MEMBER M
ORDER BY
		M.NAME DESC OFFSET ? LIMIT ?
```

> MySQL

```
SELECT
		M.ID AS ID,
		M.AGE AS AGE,
		M.TEAM_ID AS TEAM_ID,
		M.NAME AS NAME
FROM
		MEMBER M
ORDER BY
		M.NAME DESC LIMIT ?, ?
```

> PostgreSQL

```
SELECT
		M.ID AS ID,
		M.AGE AS AGE,
		M.TEAM_ID AS TEAM_ID,
		M.NAME AS NAME
FROM
		MEMBER M
ORDER BY
		M.NAME DESC LIMIT ? OFFSET ?
```

> ì˜¤ë¼í´

```
SELECT *
FROM 
		( SELECT ROW_.*, ROWNUM ROWNUM_
			FROM
					( SELECT
							M.ID AS ID,
							M.AGE AS AGE,
							M.TEAM_ID AS TEAM_ID,
							M.NAME AS NAME
						FROM MEMBER M
						ORDER BY M.NAME
					) ROW_
			WHERE ROWNUM <= ?
		)
WHERE ROWNUM_ > ?
```

> SQL Server

```
WITH query AS (
		SELECT 
		inner_query.*,
		ROW_NUMBER() OVER (ORDER BY CURRNT_TIMESTAMP) as __hibernate_row_nr__
		FROM
				( select
							TOP(?) m.id as id,
							m.age as age,
							m.team as team_id,
							m.name as name,
					from Member m
					order by m.name DESC
				) inner_query
)
SELECT id, age, team_id, name
FROM query
where __hibernate_row_nr__ >= ? AND __hibernate_row_nr__ < ?
```



#### ì§‘í•©ê³¼ ì •ë ¬

> ì§‘í•©ì€ ì§‘í•©í•¨ìˆ˜ì™€ í•¨ê»˜ í†µê³„ ì •ë³´ë¥¼ êµ¬í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©

- ```
  select
  		COUNT(m),   //íšŒì›ìˆ˜
  		SUM(m.age), //ë‚˜ì´ í•©  
  		AVG(m.age), //í‰ê·  ë‚˜ì´
  		MAX(m.age), //ìµœëŒ€ ë‚˜ì´
  		MIN(m.age)  //ìµœì†Œ ë‚˜ì´
  from Member m
  ```



#### ì§‘í•¨ í•¨ìˆ˜

| í•¨ìˆ˜                                                         | ì„¤ëª…                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [COUNT](https://www.notion.so/COUNT-5a77f35c7dc14adf853379433b159e87) | ê²°ê³¼ ìˆ˜ë¥¼ ë°˜í™˜. (Long)                                       |
| [MAX, MIN](https://www.notion.so/MAX-MIN-addd17f597f34426abd90e65c7e6e502) | ìµœëŒ€, ìµœì†Œ ê°’ì„ ë°˜í™˜. ë¬¸ì, ìˆ«ì ë‚ ì§œ ë“±ì— ì‚¬ìš©              |
| [AVG](https://www.notion.so/AVG-3c8da6573302414c84bc1ea454ae9d3b) | í‰ê· ê°’ì„ ë°˜í™˜. ìˆ«ìíƒ€ì…ë§Œ ì‚¬ìš© ê°€ëŠ¥ (Dobule)                 |
| [SUM](https://www.notion.so/SUM-52e73c2eff144c33befd94561608d8f0) | í•©ì„ ë°˜í™˜. ìˆ«ìíƒ€ì…ë§Œ ì‚¬ìš© ê°€ëŠ¥ (ì •ìˆ˜í˜•: Long, ì†Œìˆ˜í•©: Double, BigInter, BigDecimal) |



#### ì§‘í•¨ í•¨ìˆ˜ ì‚¬ìš©ì‹œ ì°¸ê³ ì‚¬í•­

- NULLê°’ì€ ë¬´ì‹œ, í†µê³„ì— ê°’ì´ ìˆëŠ” ê²ƒë§Œ ê²°ê³¼ì— ë°˜ì˜ ( NULLì€ ë¬´ì‹œ)

- ë§Œì•½ ê°’ì´ ì—†ëŠ”ë° ì§‘í•© í•¨ìˆ˜(SUM, AVG ë“±)ë¥¼ ì‚¬ìš©í•˜ë©´ NULL ê°’ (ë‹¨, COUNTëŠ” 0)

- DISTINCTë¥¼ ì§‘í•© í•¨ìˆ˜ ì•ˆì— ì‚¬ìš©í•´ì„œ ì¤‘ë³µ ì œê±° í›„ ì§‘í•© í•¨ìˆ˜ ì‚¬ìš© ê°€ëŠ¥

  ```
  select COUNT( DISTINCT m.age ) from Member m
  ```

- DISTINCTë¥¼ COUNTì—ì„œ ì‚¬ìš©í•  ë•Œ ì„ë² ë””ë“œ íƒ€ì…ì€ ì§€ì›í•˜ì§€ ì•ŠìŒ



#### GROUP BY, HAVING

```JAVA
groupby_ì ˆ ::= GROUP BY {ë‹¨ì¼ê°’ ê²½ë¡œ | ë³„ì¹­}+
having_ì ˆ ::= HAVING ì¡°ê±´ì‹
```

- GROUP BYëŠ” í†µê³„ ë°ì´í„°ë¥¼ êµ¬í•  ë•Œ íŠ¹ì • ê·¸ë£¹ë¼ë¦¬ ë¬¶ì–´ì£¼ëŠ” ì—­í• 

  ```
  SELECT t.name, COUNT(m.age), SUM(m.age), AVG(m.age), MAX(m.age), MIN(m.age)
  FROM Member m 
  LEFT JOIN m.team t
  GROUP BY t.name
  ```

- HAVINGì€ GROUP BYì™€ í•¨ê»˜ ì‚¬ìš©í•˜ë©°, ê·¸ë£¹í™”í•œ í†µê³„ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§ (WHERE ì—­í• )

  ```
  SELECT t.name, COUNT(m.age), SUM(m.age), AVG(m.age), MAX(m.age), MIN(m.age)
  FROM Member m 
  LEFT JOIN m.team t
  GROUP BY t.name
  HAVING AVG(m.age) >= 10
  ```

- ë³´í†µ ì´ëŸ¬í•œ ì¿¼ë¦¬ë“¤ì„ `ë¦¬í¬íŒ… ì¿¼ë¦¬`  í˜¹ì€ `í†µê³„ ì¿¼ë¦¬` ë¼ ë¶€ë¦„.
- **ê²°ê³¼ê°€ ë§ë‹¤ë©´ í†µê³„ ê²°ê³¼ë§Œ ì €ì¥í•˜ëŠ” í…Œì´ë¸”ì„ ë³„ë„ ìƒì„± í›„ ìƒˆë²½ì— í†µê³„ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•´ì„œ ë³´ê´€**



#### ì •ë ¬(ORDER BY)

> ê²°ê³¼ë¥¼ ì •ë ¬í•  ë•Œ ì‚¬ìš©

```
orderby_ì ˆ :: = ORDER BY {ìƒíƒœí•„ë“œ ê²½ë¡œ | ê²°ê³¼ ë³€ìˆ˜ {ASC | DESC}}+

select m from Member m order by m.age DESC, m.username ASC
```

- **ASC : ì˜¤ë¦„ì°¨ìˆœ (ê¸°ë³¸ê°’)**

- **DESC: ë‚´ë¦¼ì°¨ìˆœ**

-----

### JPQL ì¡°ì¸

> JPQLë„ ì¡°ì¸ì„ ì§€ì›í•˜ëŠ”ë° SQL ì¡°ì¸ê³¼ ê¸°ëŠ¥ì€ ê°™ê³  ë¬¸ë²•ë§Œ ì•½ê°„ ë‹¤ë¦„



#### ë‚´ë¶€ ì¡°ì¸

```java
String teamName = "íŒ€A";
String query = "SELECT m FROM Member m INNER JOIN m.team t"
					+ "WHERE t.name = :teamName";
					
List<Member> members = em.createQuery(query, Member.class)
	.setParameter("teamName", teamName)
	.getResultList();
```

- INNER JOINì„ ì‚¬ìš©(INNERëŠ” ìƒëµ ê°€ëŠ¥)

  ```sql
  //JPQL
  SELECT m
  FROM Member m INNER JOIN m.team t
  where t.name = 'íŒ€A';
  
  //SQL
  SELECT 
  		M.ID AS ID,
  		M.AGE AS AGE,
  		M.TEAM_ID AS TEAM_ID,
  		M.NAME AS NAME
  FROM 
  		MEMBER M INNER JOIN TEAM T ON M.TEAM_ID = T.ID
  WHERE 
  		T.NAME = ?
  ```

+ `Member m JOIN m.team t`: ì—°ê´€ í•„ë“œë¡œ íŒ€ê³¼ ì¡°ì¸. ì¡°ì¸í•œ íŒ€ì—ëŠ” të¼ëŠ” ë³„ì¹­ì´ í•„ìš”

  ```
  FROM Member m JOIN Team t //ì˜ëª»ëœ JPQL ì¡°ì¸, ì˜¤ë¥˜ ë°œìƒ
  ```

- **ì„œë¡œ ë‹¤ë¥¸ íƒ€ì…ì˜ ë‘ ì—”í‹°í‹°ë¥¼ ì¡°íšŒ**í•˜ë©´ `TypeQuery` ëª» ì”€. ë‹¤ìŒì²˜ëŸ¼ ì¡°íšŒí•´ì•¼ ê°€ëŠ¥

  ```java
  String query = "SELECT m, t FROM  Member m JOIN m.team t";
  List<Object[]> result = em.createQuery(query).getResultList();
  
  for (Object[] row : result) {
  		Member member = (Member) row[0];
  		Team team = (Team) row[1];
  }
  ```



#### ì™¸ë¶€ ì¡°ì¸

- LEFT [OUTER] JOINì„ ì‚¬ìš©(OUTERëŠ” ë³´í†µ ìƒëµ)

  ```
  //JPQL
  SELECT m
  FROM Member m LEFT [OUTER] JOIN m.team t
  
  //SQL
  SELECT 
  		M.ID AS ID,
  		M.AGE AS AGE,
  		M.TEAM_ID AS TEAM_ID,
  		M.NAME AS NAME
  FROM 
  		MEMBER M LEFT OUTER JOIN TEAM T ON M.TEAM_ID = T.ID
  WHERE 
  		T.NAME = ?
  ```



#### ì»¬ë ‰ì…˜ ì¡°ì¸

- ì¼ëŒ€ë‹¤, ë‹¤ëŒ€ë‹¤ ê´€ê³„ì²˜ëŸ¼ ì»¬ë ‰ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ê³³ì— ì¡°ì¸í•˜ëŠ” ê²ƒì„ ì˜ë¯¸

- [íšŒì› â†’ íŒ€]ì˜ ì¡°ì¸ì€ ë‹¤ëŒ€ì¼ ì¡°ì¸ì´ë©´ì„œ **ë‹¨ì¼ ê°’ ì—°ê´€ í•„ë“œ(m.team)ë¥¼ ì‚¬ìš©**

- [íŒ€ â†’ íšŒì›]ì˜ ì¡°ì¸ì€ ì¼ëŒ€ë‹¤ ì¡°ì¸ì´ë©´ì„œ ì»¬ë ‰ì…˜

   **ê°’ ì—°ê´€ í•„ë“œ(m.members)ë¥¼ ì‚¬ìš©**

  ```
  SELECT t, m From Team t LEFT JOIN t.members m
  ```

- **ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ í•„ë“œëŠ” ì™¸ë¶€ ì¡°ì¸ì„ ì‚¬ìš©** (ë‚´ë¶€ ì¡°ì¸ì‹œ ì¡°íšŒ ì•ˆë˜ëŠ” ë¬¸ì œ ë°œìƒ)



#### ì„¸íƒ€ ì¡°ì¸

- WHERE ì ˆì„ ì‚¬ìš©í•˜ë©°, **ì„¸íƒ€ ì¡°ì¸ì€ ë‚´ë¶€ ì¡°ì¸ë§Œ ì§€ì›**

- ì„¸íƒ€ ì¡°ì¸ì„ ì‚¬ìš©í•˜ë©´ ì „í˜€ ê´€ê³„ ì—†ëŠ” ì—”í‹°í‹°ë„ ì¡°ì¸ì´ ê°€ëŠ¥

  ```
  //JPQL
  select coumt(m) from Member m, Team t
  where m.username = t.name
  
  //SQL
  SELECT COUNT(M.ID)
  FROM 
  		MEBER M CROSS JOIN TEAM T
  WHERE 
  		M.USERNAME = T.NAME
  ```



#### JOIN ON ì ˆ(JPA 2.1)

- JPA 2.1ë¶€í„° ì¡°ì¸í•  ë•Œ ON ì ˆì„ ì§€ì›

- ON ì ˆì„ ì‚¬ìš©í•˜ë©´ ì¡°ì¸ ëŒ€ìƒì„ í•„í„°ë§ í•œ í›„ ì¡°ì¸ì´ ê°€ëŠ¥

- ë‚´ë¶€ ì¡°ì¸ì˜ ONì ˆì€ WHERE ì ˆì„ ì‚¬ìš©í•  ë•Œì™€ ê²°ê³¼ê°€ ê°™ê¸°ì— ì™¸ë¶€ ì¡°ì¸ì—ì„œë§Œ ì‚¬ìš©

  ```
  //JPQL
  select m, t from Member m
  left join m.team t on t.name = 'A'
  
  //SQL
  SELECT m.*, t.* FROM Member m
  LEFT JOIN Team t ON m.TEAM_ID = t.id and t.name = 'A'
  ```

----

### íŒ¨ì¹˜ ì¡°ì¸ 

> SQLì—ì„œ ì´ì•¼ê¸°í•˜ëŠ” ì¡°ì¸ ì¢…ë¥˜ê°€ ì•„ë‹Œ JPQ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ì œê³µí•˜ëŠ” ê¸°ëŠ¥

```
íŒ¨ì¹˜ ì¡°ì¸ ::= [LEFT [OUTER] | INNER] JOIN FETCH ì¡°ì¸ê²½ë¡œ
```



#### ì—”í‹°í‹° í˜ì¹˜ ì¡°ì¸

- ì—°ê´€ëœ ì—”í‹°í‹°ë‚˜ ì»¬ë ‰ì…˜ì„ í•¨ê»˜ ì¡°íšŒ, JPQL ì¡°ì¸ê³¼ëŠ” ë‹¤ë¥´ê²Œ í˜ì¹˜ ì¡°ì¸ì€ ë³„ì¹­ ì‚¬ìš© ëª»í•¨ (í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” í˜ì¹˜ ì¡°ì¸ì—ë„ ë³„ì¹­ í—ˆìš©)

  ```
  //JPQL
  select m
  from Member m join fetch m.team //mê³¼ m.teamì„ ê°™ì´ ì¡°íšŒ
  
  //ì‹¤ì œ ì‹¤í–‰ëœ SQL
  SELECT M.*, T.*
  FROM MEMBER M
  INNER JOIN TEAM T ON M.TEAM_ID=T.ID
  ```

  - JPQLì—ì„œ `select m` ì¡°íšŒí–ˆì§€ë§Œ ì—°ê´€ëœ íŒ€ë„ í•¨ê»˜ ì¡°íšŒ (fetch ì¡°ì¸ì€ ì—°ê´€ ì—”í‹°í‹° ì¡°íšŒ)

<img src="https://user-images.githubusercontent.com/101400894/178446756-dd269cb4-9706-4301-a519-4f6e660ba5d6.png" alt="image" style="zoom:80%;" />

+ íŒ¨ì¹˜ ì¡°ì¸ ì‚¬ìš©

  ```java
  String jpql = "select m from Member m join fetch m.team";
  
  List<Member> members = em.createQuery(jpql, Member.class)
  	.getResultList();
  
  for(Member member : members){
  	//íŒ¨ì¹˜ ì¡°ì¸ìœ¼ë¡œ íšŒì›ê³¼ íŒ€ì„ í•¨ê»˜ ì¡°íšŒí•´ì„œ ì§€ì—° ë¡œë”© ë°œìƒ x
  	System.out.pritnln("username = " + member.getUsername() + ", " +
  		"teamname = " + member.getTeam().name());
  }
  ```



#### ì»¬ë ‰ì…˜ í˜ì¹˜ ì¡°ì¸

```
//JPQL
select t
from Team t join fetch t.members
where t.name = 'íŒ€A'

//ì‹¤ì œ ì‹¤í–‰ëœ SQL
SELECT T.*, M.*
FROM TEAM T
INNER JOIN MEMBER M ON T.ID=M.TEAM_ID
WHERE T.NAME = 'íŒ€A'
```

- íŒ€AëŠ” í•˜ë‚˜ì§€ë§Œ Member í…Œì´ë¸”ê³¼ ì¡°ì¸í•˜ë©´ì„œ ê²°ê³¼ ê°’ ì¦ê°€ (íŒ€ A 2ê±´ ì¡°íšŒ)

ğŸ“Œì¼ëŒ€ë‹¤ ì¡°ì¸ì€ ê²°ê³¼ê°€ ì¦ê°€í•  ìˆ˜ ìˆì§€ë§Œ ì¼ëŒ€ì¼ ,ë‹¤ëŒ€ì¼ì€ ê²°ê³¼ê°€ ì¦ê°€í•˜ì§€ ì•ŠìŒ

![image](https://user-images.githubusercontent.com/101400894/178447861-1912b96d-0f2d-480a-90ad-9c33d061cfcf.png)<img src="https://user-images.githubusercontent.com/101400894/178447916-4efef9ee-fe25-47e5-b604-af761e8e06c8.png" alt="image" style="zoom:80%;" />

<img src="https://user-images.githubusercontent.com/101400894/178447978-63caf5b9-f417-459b-88d4-6e0c7bb6dded.png" alt="image" style="zoom:100%;" align="left"/>



#### ì»¬ë ‰ì…˜ í˜ì¹˜ ì¡°ì¸ ì‚¬ìš©ì‹œ ë‚˜ì˜¤ëŠ” ë¬¸ì œ

- ë™ì¼í•œ ê²°ê³¼ê°’ì´ 2ë²ˆ ì¶œë ¥ë˜ëŠ” í˜„ìƒ ë°œìƒ (íŒ€ Aê°€ 2ê±´ ì¡°íšŒ)

```
String jpql = "select t from Team t join fetch t.members where t.name = 'íŒ€A'"
List<Team> team = em.createQuery(jpql, Team.class).getResultList();

for(Team team: teams) {
		System.out.println("teamname = " + team.getName() + ", team = " + team);
		for (Member member : team.getMembers()) {
				System.out.println("->username = " + member.getUsername() + 
				", member = " + member);
		}
}

//ì¶œë ¥ ê²°ê³¼
teamname = íŒ€A, team = Team@0x100
->username = íšŒì›1, member = Member@0x200
->username = íšŒì›2, member = Member@0x300
teamname = íŒ€A, team = Team@0x100
->username = íšŒì›1, member = Member@0x200
->username = íšŒì›2, member = Member@0x300
```



#### í˜ì¹˜ ì¡°ì¸ê³¼ DISTINCT

> JPQLì˜ DISTINCTëª…ë ¹ì–´ëŠ” SQLì— DISTINCTë¥¼ ì¶”ê°€í•˜ê³ , ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í•œë²ˆ ë” ì¤‘ë³µì„ ì œê±°

- ```
  //JPQL
  select distinct t
  from Team t join fetch t.members
  where t.name = 'íŒ€A'
  
  //ì• í”Œë¦¬ì¼€ì´ì…˜ ì¶œë ¥ ê²°ê³¼
  teamname = íŒ€A, team = Team@0x100
  ->username = íšŒì›1, member = Member@0x200
  ->username = íšŒì›2, member = Member@0x200
  ```

  - SQLì˜ DISTINCTë¥¼ ì¶”ê°€í•˜ì—¬ë„ ë°ì´í„°ê°€ ë‹¤ë¥´ë¯€ë¡œ íš¨ê³¼ê°€ ì—†ìŒ

  - ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¤‘ë³µëœ ë°ì´í„°ë¥¼ ì œê±°í•˜ë¯€ë¡œ í•˜ë‚˜ë§Œ ì¡°íšŒ



#### í˜ì¹˜ ì¡°ì¸ê³¼ ì¼ë°˜ ì¡°ì¸ì˜ ì°¨ì´

> JPQLì€ ê²°ê³¼ë¥¼ ë°˜í™˜í•  ë•Œ ì—°ê´€ê´€ê³„ëŠ” ê³ ë ¤í•˜ì§€ ì•Šê³  ë‹¨ì§€ **SELECT ì ˆì— ì—”í‹°í‹°ë§Œì„ ì¡°íšŒ**

```
//ë‚´ë¶€ ì¡°ì¸ JPQL
select t
from Team t join t.member m
where t.name = 'íŒ€A'

//ì‹¤í–‰ëœ SQL
SELECT T.*
FROM TEAM T
INNER JOIN MEMBER M ON T.ID=M.TEAM_ID
WHERE T.NAME = 'íŒ€A'

//íŒ¨ì¹˜ ì¡°ì¸
select distinct t
from Team t join fetch t.members
where t.name = 'íŒ€A'

//í˜ì¹˜ ì¡°ì¸ì˜ ê²½ìš°
SELECT T.*, M.*
FROM TEAM T
INNER JOIN MEMBER M ON T.ID=M.TEAM_ID
WHERE T.NAME = 'íŒ€A'
```

- íšŒì› ì»¬ë ‰ì…˜ì„ ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•˜ë©´ í”„ë¡ì‹œë‚˜ ì´ˆê¸°í™”í•˜ì§€ ì•Šì€ ì»¬ë ‰ì…˜ ë˜í¼ë¥¼ ë°˜í™˜ 
- ì¦‰ì‹œ ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•˜ë©´ íšŒì› ì»¬ë ‰ì…˜ì„ ìœ„í•´ ì¿¼ë¦¬ë¥¼ í•œë²ˆ ë” ì‹¤í–‰



#### í˜ì¹˜ ì¡°ì¸ì˜ íŠ¹ì§•ê³¼ í•œê³„

- `ê¸€ë¡œë²Œ ë¡œë”© ì „ëµ` : ì—”í‹°í‹°ì— ì§ì ‘ ì ìš©í•˜ëŠ” ë¡œë”© ì „ëµì„ ì˜ë¯¸, ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ ì˜í–¥ì„ ë°œìƒ

  ```
  @OneToMany(fetch = FetchType.LAZY) //ê¸€ë¡œë²Œ ë¡œë”© ì „ëµ
  ```

- í˜ì¹˜ ì¡°ì¸ì€ ê°ì²´ ê·¸ë˜í”„ë¥¼ ìœ ì§€í•  ë•Œ ì‚¬ìš©í•˜ë©´ íš¨ê³¼ì 

- ì—¬ëŸ¬ í…Œì´ë¸”ì„ ì¡°ì¸í•´ **ì—”í‹°í‹°ê°€ ì•„ë‹Œ ì „í˜€ ë‹¤ë¥¸ ê²°ê³¼ê°€ í•„ìš”í•œ ê²½ìš° DTOë¥¼ ì“°ëŠ”ê²Œ íš¨ê³¼ì **



**í˜ì¹˜ ì¡°ì¸ì˜ ì¥ì **

- í˜ì¹˜ ì¡°ì¸ì€ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•¨ê»˜ ì¡°íšŒí•˜ì—¬ SQL í˜¸ì¶œ íšŸìˆ˜ë¥¼ ì¤„ì—¬ ì„±ëŠ¥ ìµœì í™”ê°€ ê°€ëŠ¥

- í˜ì¹˜ ì¡°ì¸ì€ ê¸€ë¡œë²Œ ë¡œë”© ì „ëµë³´ë‹¤ ìš°ì„  ì ìš© ( **ìš°ì„ ìˆœìœ„: í˜ì¹˜ ì¡°ì¸ > ê¸€ë¡œë²Œ ë¡œë”©ì „ëµ** (FetchType.LAZY))

- ê¸€ë¡œë²Œ ë¡œë”©ì„ ì¦‰ì‹œ ë¡œë”©ì„ ì“°ë©´ ì„±ëŠ¥ì— ì•…ì˜í–¥ì¸ ê²½ìš°(ìì£¼ ë¡œë”©) ë³€ê²½ì— ì–´ë ¤ì›€ ë°œìƒ
  -   **ê¸€ë¡œë²Œ ë¡œë”©ì„ ì§€ì—° ë¡œë”©**ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  **ìµœì í™”ê°€ í•„ìš”í•˜ë©´ í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©**ì´ íš¨ê³¼ì 

- **ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì¿¼ë¦¬ ì‹œì ì— ì¡°íšŒ**í•˜ë¯€ë¡œ ì§€ì—°ë¡œë”© ë°œìƒí•˜ì§€ ì•ŠìŒ 
  - **ì¤€ì˜ì† ìƒíƒœì—ì„œë„ ê°ì²´ ê·¸ë˜í”„ íƒìƒ‰ ê°€ëŠ¥**



**í˜ì¹˜ ì¡°ì¸ì˜ ë‹¨ì **

+ **í˜ì¹˜ ì¡°ì¸ ëŒ€ìƒì— ë³„ì¹­ì„ ì“¸ ìˆ˜ ì—†ìŒ**

  - ë³„ì¹­ì´ ì—†ìœ¼ë¯€ë¡œ SELECT, WHERE, ì„œë¸Œ ì¿¼ë¦¬ì— í˜ì¹˜ ì¡°ì¸ ëŒ€ìƒì„ ì‚¬ìš© ëª»í•¨

  - JPAí‘œì¤€ì—ëŠ” ì§€ì›í•˜ì§€ ì•Šì§€ë§Œ í•˜ì´ë²„ë„¤ì´íŠ¸ ë“± ëª‡ëª‡ êµ¬í˜„ì²´ëŠ” ë³„ì¹­ì„ ì§€ì› í•˜ì§€ë§Œ ë³„ì¹­ì„ ì˜ëª»ì‚¬ìš©í•˜ë©´ ë°ì´í„° ë¬´ê²°ì„±ì— ë¬¸ì œê°€ ë°œìƒ (ë°ì´í„°ê°€ ìˆ˜ê°€ í‹€ë¦¼) 
    - íŠ¹íˆ, 2ì°¨ ìºì‹œì™€ í•¨ê»˜ ì“¸ ë•Œ ë°ì´í„° ìˆ˜ê°€ ë‹¬ë¼ì§ˆ ê²½ìš° ë‹¤ë¥¸ ê³³ì— ì—°ê´€ëœ ë°ì´í„°ë„ ë¬¸ì œ ë°œìƒ



+ **ë‘˜ ì´ìƒì˜ ì»¬ë ‰ì…˜ì„ í˜ì¹˜ ëª»í•¨**

  - êµ¬í˜„ì²´ì— ë”°ë¼ ë ìˆ˜ë„ ìˆì§€ë§Œ ( ì»¬ë ‰ì…˜ * ì»¬ë ‰ì…˜ )ì˜ **ì¹´í…Œì‹œì•ˆ ê³±ì´ ë°œìƒ**í•˜ì—¬ ì£¼ì˜ í•„ìš”

  - í•˜ì´ë²„ë„¤ì´íŠ¸ì—ì„  `org.hibernate.loader.MultipleBagFetchException` ì˜ˆì™¸ ë°œìƒ



+ ì»¬ë ‰ì…˜ì„ í˜ì¹˜ ì¡°ì¸í•˜ë©´ í˜ì´ì§• API(`setFirstResult`, `setMaxResults`) ì‚¬ìš© ëª»í•¨

  - ì»¬ë ‰ì…˜(ì¼ëŒ€ë‹¤)ì´ ì•„ë‹Œ **ë‹¨ì¼ í•„ë“œ(ì¼ëŒ€ì¼, ë‹¤ëŒ€ì¼)ë“¤ì€ í˜ì´ì§• API ì‚¬ìš© ê°€ëŠ¥**

  - í•˜ì´ë²„ë„¤ì´íŠ¸ì—ì„  ì»¬ë ‰ì…˜ì„ í˜ì¹˜ ì¡°ì¸í•˜ê³  í˜ì´ì§• APIì‚¬ìš©í•˜ë©´ ê²½ê³  ë¡œê·¸ ë°œìƒ í›„ ì²˜ë¦¬
    - ë°ì´í„°ê°€ ì ìœ¼ë©´ ìƒê´€ ì—†ì§€ë§Œ **ë§ì€ ê²½ìš° ì„±ëŠ¥ ì´ìŠˆì™€ ë©”ëª¨ë¦¬ ì´ˆê³¼ ì˜ˆì™¸ ë°œìƒ**í•˜ë¯€ë¡œ ìœ„í—˜

---

### ê²½ë¡œ í‘œí˜„ì‹

> ê²½ë¡œ í‘œí˜„ì‹ì´ë¼ëŠ” ê²ƒì€ ì‰½ê²Œ ì´ì•¼ê¸°í•´ì„œ .(ì )ì„ ì°ì–´ ê°ì²´ ê·¸ë˜í”„ë¥¼ íƒìƒ‰í•˜ëŠ” ê²ƒì„ ì˜ë¯¸



#### ê²½ë¡œ í‘œí˜„ì‹ì˜ ìš©ì–´ ì •ë¦¬

- ìƒíƒœ í•„ë“œ: ë‹¨ìˆœíˆ ê°’ì„ ì €ì¥í•˜ê¸° ìœ„í•œ í•„ë“œ (`m.username`, `m.age`)

- ì—°ê´€ í•„ë“œ: ì—°ê´€ê´€ê³„ë¥¼ ìœ„í•œ í•„ë“œ, ì„ë² ë””ë“œ íƒ€ì… í¬í•¨

  - ë‹¨ì¼ ê°’ ì—°ê´€ í•„ë“œ: @ManyToOne, @OneToOne, ëŒ€ìƒì´ ì—”í‹°í‹° (`m.team`)

  - ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ í•„ë“œ: @OneToMany, @ManyToMany, ëŒ€ìƒì´ ì»¬ë ‰ì…˜ (`t.members`)



```java
@Entity
public class Member{

	@Id @GeneratedValue
	private Long id;
	
	@Column(name="name")
	private String username; //ìƒíƒœ í•„ë“œ
	private Integer age; //ìƒíƒœ í•„ë“œ
	
	@ManyToOne(..)
	private Team team; //ì—°ê´€í•„ë“œ(ë‹¨ì¼ê°’ ì—°ê´€ í•„ë“œ)
	
	@OneToMany(..)
	private List<Order> orders; //ì—°ê´€í•„ë“œ(ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ í•„ë“œ)
}
```

#### ëª…ì‹œì  ì¡°ì¸ê³¼ ë¬µì‹œì  ì¡°ì¸

- ëª…ì‹œì  ì¡°ì¸: JOINì„ ì§ì ‘ ì ì–´ì£¼ëŠ” ê²ƒ

  ```
  SELECT m FROM Member m JOIN m.team t
  ```

- ë¬µì‹œì  ì¡°ì¸: ê²½ë¡œ í‘œí˜„ì‹ì— ì˜í•´ ë¬µì‹œì ìœ¼ë¡œ ì¡°ì¸ì´ ë°œìƒí•˜ëŠ” ê²ƒ, ë‚´ë¶€ì¡°ì¸ë§Œ ê°€ëŠ¥

  ```
  SELECT m.team FROM Member m
  ```



#### ê²½ë¡œ í‘œí˜„ì‹ê³¼ íŠ¹ì§•

- ìƒíƒœ í•„ë“œ ê²½ë¡œ : ê²½ë¡œ íƒìƒ‰ì˜ ë, ë”ëŠ” íƒìƒ‰ ëª»í•¨

  - ìƒíƒœ í•„ë“œ ê²½ë¡œ íƒìƒ‰

    ```
    //JPQL
    select m.username, m.age from Member
    ```

- ë‹¨ì¼ ê°’ ì—°ê´€ ê²½ë¡œ : ë¬µì‹œì ìœ¼ë¡œ ë‚´ë¶€ ì¡°ì¸ ë°œìƒ, ê°’ ì—°ê´€ ê²½ë¡œ ê³„ì† íƒìƒ‰ ê°€ëŠ¥ (ì™¸ë¶€ ì¡°ì¸ì€ ëª…ì‹œì ìœ¼ë¡œ JOIN í‚¤ì›Œë“œ í•„ìš”)

  - ë‹¨ì¼ ê°’ ì—°ê´€ ê²½ë¡œ íƒìƒ‰

    ```
    //JPQL
    select o.member from Order o
    
    //ì‹¤í–‰ SQL
    select m.*
    from Orders o
    		inner join Member m on o.member_id=m.id //ë¬µì‹œì  ì¡°ì¸ (ëª¨ë‘ ë‚´ë¶€ ì¡°ì¸)
    ```

- ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ ê²½ë¡œ : ë¬µì‹œì ìœ¼ë¡œ ë‚´ë¶€ ì¡°ì¸ ë°œìƒ, ë”ëŠ” íƒìƒ‰ ëª»í•¨ ë‹¨, FROM ì ˆì—ì„œ ì¡°ì¸ì„ í†µí•´ ë³„ì¹­ì„ ì–»ìœ¼ë©´ ë³„ì¹­ìœ¼ë¡œ íƒìƒ‰ ê°€ëŠ¥

  - ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ ê²½ë¡œ íƒìƒ‰

    - JPQLì—ì„œ ë§ì´ í•˜ëŠ” ì‹¤ìˆ˜ê°€ ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ ê²½ë¡œ íƒìƒ‰ì„ ì‹œë„í•˜ëŠ” ê²ƒ

    ```
    select t.members from Team t //ì„±ê³µ
    
    select t.members.username from Team t//ì‹¤íŒ¨
    -> select m.username from Team t join t.members m //ìƒˆë¡œìš´ ë³„ì¹­ í•„ìš”
    ```

  - ì»¬ë ‰ì…˜ì€ ì»¬ë ‰ì…˜ì˜ í¬ê¸°ë¥¼ êµ¬í•˜ëŠ” sizeë¼ëŠ” ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥ (SQL COUNT í•¨ìˆ˜ ì‚¬ìš©)

    ```
    select t.members.size from Team t //ì„±ê³µ
    ```



#### ê²½ë¡œ í‘œí˜„ì‹ì˜ ë³µì¡í•œ ì˜ˆì‹œ

- ì„ë² ë””ë“œ íƒ€ì… ì ‘ê·¼ë„ ë‹¨ì¼ ê°’ ê²½ë¡œ íƒìƒ‰ì´ì§€ë§Œ ì£¼ë¬¸ í…Œì´ë¸”ì— í¬í•¨ë˜ì–´ ì¡°ì¸ ë°œìƒX

```
//JPQL
select o.member.team
from Order o
where o.product.name = 'productA' and o.address.city = 'JINJU'

//ì‹¤í–‰ëœ SQL
SELECT T.*
FROM ORDERS O
INNER JOIN MEMBER M ON O.MEMBER_ID=M.ID
INNER JOIN TEAM T ON M.TEAM_ID=T.ID
INNER JOIN PRODUCT P ON O.PRODUCT_ID=P.ID
WHERE P.NAME='productA' AND O.CITY='JINJU'
```



#### ê²½ë¡œ íƒìƒ‰ì„ ì‚¬ìš©í•œ ë¬µì‹œì  ì¡°ì¸ ì‹œ ì£¼ì˜ì‚¬í•­

- í•­ìƒ ë‚´ë¶€ ì¡°ì¸ (INNER JOIN)

- ì»¬ë ‰ì…˜ì€ ê²½ë¡œ íƒìƒ‰ì˜ ë, ì»¬ë ‰ì…˜ì—ì„œ ê²½ë¡œ íƒìƒ‰ì„ í•˜ë ¤ë©´ ëª…ì‹œì ì¸ ì¡°ì¸ ë³„ì¹­ì´ í•„ìš”

  ```
  select t.members from Team t // ì„±ê³µ
  select t.members.username from Team t //ì‹¤íŒ¨
  select m.username from Team t join t.members m //ì¡°ì¸ì„ í†µí•´ ìƒˆë¡œìš´ ë³„ì¹­ì„ ì–»ì–´ì•¼ ê°€ëŠ¥
  ```

- ê²½ë¡œ íƒìƒ‰ì€ ì£¼ë¡œ SELECT, WHEREì ˆì—ì„œ ì‚¬ìš©í•˜ì§€ë§Œ ë¬µì‹œì  ì¡°ì¸ìœ¼ë¡œ ì¸í•´ FROMì ˆì— ì˜í–¥

- ë¬µì‹œì  ì¡°ì¸ì€ **ì¡°ì¸ì´ ì¼ì–´ë‚˜ëŠ” ìƒí™©ì„ íŒŒì•…í•˜ê¸° ì–´ë µë‹¤ëŠ” ë‹¨ì **, **ëª…ì‹œì  ì¡°ì¸ ì‚¬ìš©ì„ ì¶”ì²œ**

----

### ì„œë¸Œì¿¼ë¦¬

- JPQLë„ ì„œë¸Œì¿¼ë¦¬ë¥¼ ì§€ì›

- WHERE, HAVING ì ˆì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥, SELECT, FROM ì ˆì—ëŠ” ì‚¬ìš© ë¶ˆê°€

  - í•˜ì´ë²„ë„¤ì´íŠ¸ HQLì€ SELECT ì ˆì˜ ì„œë¸Œ ì¿¼ë¦¬ í—ˆìš©

  ```java
  select m from Member m
  where m.age > (select avg(m2.age) from Member m2)
  ```

  ```java
  select m from Member m
  where (select count(o) from Order o where m = o.member)>0
      
  //ê°™ì€ ì¿¼ë¦¬
  select m from Member m
  where m.orders.size > 0
  ```

  

#### ì„œë¸Œ ì¿¼ë¦¬ í•¨ìˆ˜

- `[NOT] EXISTS (subquery)` : ì„œë¸Œì¿¼ë¦¬ì— ê²°ê³¼ê°€ ì¡´ì¬í•˜ë©´ ì°¸. NOTì€ ë°˜ëŒ€

  ```sql
  //ì˜ˆ: íŒ€ Aì†Œì†ì¸ íšŒì›
  select m from Member m
  where exists (select t from m.team t where t.name = 'íŒ€A')
  ```



- `{ALL | ANY | SOME} (subquery)` : ë¹„êµ ì—°ì‚°ìì™€ ê°™ì´ ì‚¬ìš©

  - ALL: ì¡°ê±´ì„ ëª¨ë‘ ë§Œì¡±í•˜ë©´ ì°¸

  - ANY í˜¹ì€ SOME : ë‘˜ë‹¤ ê°™ì€ ì˜ë¯¸ì´ë©° ì¡°ê±´ì„ í•˜ë‚˜ë¼ë„ ë§Œì¡±í•˜ë©´ ì°¸
  - ë¹„êµ ì—°ì‚°ìì™€ ê°™ì´ ì‚¬ìš© {=, >, >=, <, <=}

  ```sql
  //ì˜ˆ: ì „ì²´ ìƒí’ˆ ê°ê°ì˜ ì¬ê³ ë³´ë‹¤ ì£¼ë¬¸ëŸ‰ì´ ë§ì€ ì£¼ë¬¸ë“¤
  select o from Order o
  where o.orderAmount > ALL (select p.stockAmount from Product p)
  
  //ì˜ˆ: ì–´ë–¤ íŒ€ì´ë“  íŒ€ì— ì†Œì†ëœ íšŒì›
  select m from Member m
  where m.team = ANY (select t from Team t)
  ```



- `[NOT] IN (subquery)` : ì„œë¸Œì¿¼ë¦¬ ê²°ê³¼ê°€ í•˜ë‚˜ë¼ë„ ê°™ì€ê²Œ ìˆìœ¼ë©´ ì°¸. ì„œë¸Œì¿¼ë¦¬ ì•„ë‹Œ ê³³ë„ ì‚¬ìš©

  ```sql
  //ì˜ˆ: 20ì„¸ ì´ìƒì„ ë³´ìœ í•œ íŒ€
  select t from Team t
  where t IN (select t2 From Team t2 JOIN t2.members m2 where m2.age >= 20)
  ```

----

### ì¡°ê±´ì‹

#### íƒ€ì… í‘œí˜„

| ì¢…ë¥˜        | ì„¤ëª…                                                         | ì˜ˆì œ                                                         |
| :---------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| ë¬¸ì        | ì‘ì€ ë”°ì˜´í‘œ ì‚¬ì´ì— í‘œí˜„ ì‘ì€ ë”°ì˜´í‘œë¥¼ í‘œí˜„í•˜ê³  ì‹¶ìœ¼ë©´ ì‘ì€ ë”°ì˜´í‘œ ì—°ì† ì£¼ê°œ('') ì‚¬ìš© | 'HELLO' 'She''s'                                             |
| ìˆ«ì        | L (Long íƒ€ì… ì§€ì •) D (Double íƒ€ì… ì§€ì •) F (Float íƒ€ì… ì§€ì •)  | 10L 10D 10F                                                  |
| ë‚ ì§œ        | DATE {d 'yyyy-mm-dd'} TIME (t 'hh-mm-ss'} DATETIME {ts 'yyyy-mm-dd hh:mm:ss.f'} | {d '2021-08-21'} {t '10-11-11'} {ts '2021-08-21 10-11-11.123'} m.createDate = {d '2021-08-21'} |
| Boolean     | TRUE, FALSE                                                  |                                                              |
| Enum        | íŒ¨í‚¤ì§€ëª…ì„ í¬í•¨í•œ ì „ì²´ ì´ë¦„ì„ ì‚¬ìš©                           | jpabook.MemberType.Admin                                     |
| ì—”í‹°í‹° íƒ€ì… | ì—”í‹°í‹°ì˜ íƒ€ì…ì„ í‘œí˜„. ì£¼ë¡œ ìƒì†ê³  ê´€ë ¨í•´ì„œ ì‚¬ìš©              | TYPE(m) = Member                                             |



#### ì—°ì‚°ì ìš°ì„  ìˆœìœ„

+ ê²½ë¡œ íƒìƒ‰ ì—°ì‚°(.)
+ ìˆ˜í•™ ì—°ì‚°: +, -, *, ...
+ ë¹„êµ ì—°ì‚°: =, >, â‰¥ .. BETWEEN, LIKE, IN, IS NULL, EMPTY ...
+ ë…¼ë¦¬ ì—°ì‚°: NOT, AND ,OR



#### ë…¼ë¦¬ ì—°ì‚°ê³¼ ë¹„êµì‹

- ë…¼ë¦¬ ì—°ì‚°

  - AND: ë‘˜ë‹¤ ë§Œì¡±í•˜ë©´ ì°¸

  - OR: ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ë§Œì¡±í•´ë„ ì°¸

  - NOT: ì¡°ê±´ì‹ì˜ ê²°ê³¼ ë°˜ëŒ€

- ë¹„êµì‹
  - =, >, â‰¥, <, â‰¤, <>



#### Between, IN, Like, NULL ë¹„êµ

- `X [NOT] BETWEEN A AND B`

  - XëŠ” A~B ì‚¬ì´ì˜ ê°’ì´ë©´ ì°¸(A, Bê°’ í¬í•¨)

  ```
  //ì˜ˆì œ: ë‚˜ì´ê°€ 10~20ì¸ íšŒì›ì„ ì°¾ì•„ë¼
  select m from Member m
  where m.age between 10 and 20
  ```



- `X [NOT] IN`

  - Xì™€ ê°™ì€ ì˜ˆì œì— í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì°¸ (INì€ ì„œë¸Œì¿¼ë¦¬ ì‚¬ìš© ê°€ëŠ¥)

  ```
  //ì˜ˆì œ: ì´ë¦„ì´ íšŒì›1ì´ë‚˜ íšŒì›2ì¸ íšŒì›ì„ ì°¾ì•„ë¼
  select m from Member m
  where m.username in ('íšŒì›1', 'íšŒì›2')
  ```



- `ë¬¸ìí‘œí˜„ì‹ [NOT] LIKE íŒ¨í„´ê°’ [ESCAPE ì´ìŠ¤ì¼€ì´í”„ë¬¸ì]`

  - ë¬¸ìí‘œí˜„ì‹ê³¼ íŒ¨í„´ê°’ì„ ë¹„êµ

    - `%(í¼ì„¼íŠ¸)`: ì•„ë¬´ ê°’ë“¤ì´ ì…ë ¥ë˜ì–´ë„ ê°€ëŠ¥(ê°’ì´ ì—†ì–´ë„ ë¨)

    - `_(ì–¸ë”ë¼ì¸)`: í•œ ê¸€ìëŠ” ì•„ë¬´ ê°’ì´ ì…ë ¥ë˜ì§€ë§Œ ê°’ì´ ìˆì–´ì•¼ í•¨

  ```sql
  //ì¤‘ê°„ì— ì›ì´ë¼ëŠ” ë‹¨ì–´ê°€ ë“¤ì–´ê°„ íšŒì›(ì¢‹ì€íšŒì›, íšŒì›, ì›)
  select m from Member m
  where m.username like '%ì›%'
  
  //ì²˜ìŒì— íšŒì› ì´ë¼ëŠ” ë‹¨ì–´ê°€ í¬í•¨
  where m.username like 'íšŒì›%'
  
  //ë§ˆì§€ë§‰ì— íšŒì› ì´ë¼ëŠ” ë‹¨ì–´ê°€ í¬í•¨
  where m.username like '%íšŒì›'
  
  //ì²˜ìŒì— íšŒì›ì´ë¼ëŠ” ë‹¨ì–´ê°€ í¬í•¨ + ë’¤ì— í•œê¸€ì ì¶”ê°€
  where m.username like 'íšŒì›_'
  
  //ë§ˆì§€ë§‰ì— íšŒì›ì´ë¼ëŠ” ë‹¨ì–´ê°€ í¬í•¨ + ì•ì— í•œê¸€ì ì¶”ê°€
  where m.username like '_íšŒì›'
  
  //íšŒì›%
  where m.username like 'íšŒì›\%' ESACAPE '\'
  ```



- `{ë‹¨ì¼ê°’ ê²½ë¡œ | ì…ë ¥ íŒŒë¼ë¯¸í„°} IS [NOT] NULL`

  - NULLì¸ì§€ ë¹„êµ **NULLì€** =ë¹„êµëŠ” ì•ˆë˜ê³  **ê¼­ IS NULLì„ ì‚¬ìš©**

  ```
  where m.username is null
  
  where null = null //ê±°ì§“
  where 1=1 //ì°¸
  ```



#### ì»¬ë ‰ì…˜ ì‹

> ì»¬ë ‰ì…˜ì—ë§Œ ì‚¬ìš©í•˜ëŠ” íŠ¹ë³„í•œ ê¸°ëŠ¥, ì»¬ë ‰ì…˜ ì´ì™¸ì—ì„œ ì‚¬ìš© ë¶ˆê°€

- `{ ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ ê²½ë¡œ } IS [NOT] EMPTY`

  - ì»¬ë ‰ì…˜ì— ê°’ì´ ë¹„ì—ˆìœ¼ë©´ ì°¸

  ```
  //ì˜ˆì œ: ì£¼ë¬¸ì´ í•˜ë‚˜ë¼ë„ ìˆëŠ” íšŒì› ì¡°íšŒ
  select m from Member m
  where m.orders is not empty
  
  //ì‹¤í–‰ëœ SQL
  select m.* from Member m
  where 
  		exists (
  				select o.id
  				from Order o
  				where m.id=0.member_id
  		)
  
  //is nullì€ ì»¬ë ‰ì…˜ ì‹ì´ ì•„ë‹ˆë¼ ì˜¤ë¥˜ ë°œìƒ
  select m from Member m
  where m.orders is null //ì˜¤ë¥˜ ë°œìƒ
  ```



- `{ ì—”í‹°í‹°ë‚˜ ê°’ } [NOT] MEMBER [OF] { ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ê²½ë¡œ }`

  - ì—”í‹°í‹°ë‚˜ ê°’ì´ ì»¬ë ‰ì…˜ì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì°¸

  ```
  select t from Team t
  where :memberParam member of t.members
  ```



#### ìŠ¤ì¹¼ë¼ ì‹

ìˆ«ì, ë¬¸ì, ë‚ ì§œ, case, ì—”í‹°í‹° íƒ€ì…ê³¼ ê°™ì€ ê¸°ë³¸ì ì¸ íƒ€ì…

- ìˆ˜í•™ ì‹

  - +, - : ë‹¨í•­ ì—°ì‚°ì

  - *, /, +, - : ì‚¬ì¹™ì—°ì‚°

#### ë¬¸ìí•¨ìˆ˜

| í•¨ìˆ˜                                                       | ì„¤ëª…                                                         | ì˜ˆì œ                            |
| :--------------------------------------------------------- | :----------------------------------------------------------- | :------------------------------ |
| CONCAT(ë¬¸ì1, ë¬¸ì2, ...)                                  | ë¬¸ìë¥¼ í•©í•œë‹¤                                                | CONCAT('A', 'B') = AB           |
| [SUBSTRING(ë¬¸ì, ìœ„ì¹˜, [ê¸¸ì´])                             | ìœ„ì¹˜ë¶€í„° ì‹œì‘í•´ ê¸¸ì´ë§Œí¼ ë¬¸ìë¥¼ êµ¬í•œë‹¤. ê¸¸ì´ ê°’ì´ ì—†ìœ¼ë©´ ë‚˜ë¨¸ì§€ ì „ì²´ ê¸¸ì´ë¥¼ êµ¬í•¨ | SUBSTRING('ABCDEF', 2, 3) = BCD |
| TRIM([LEADING \| TRAILING \| BOTH\] [íŠ¸ë¦¼ë¬¸ì] FROM] ë¬¸ì) | LEADING: ì™¼ìª½ë§Œ TRAILING: ì˜¤ë¥¸ìª½ë§Œ BOTH: ì–‘ìª½ ë‹¤ íŠ¸ë¦¼ë¬¸ìë¥¼ ì œê±° ê¸°ë³¸ê°’ì€ BOTH íŠ¸ë¦¼ ë¬¸ì ê¸°ë³¸ê°’ì€ ê³µë°± (SPACE) | TRIM(' ABC ' ) = 'ABC'          |
| LOWER(ë¬¸ì)                                                | ì†Œë¬¸ìë¡œ ë³€ê²½                                                | LOWER('ABC') = 'abc'            |
| UPPER(ë¬¸ì)                                                | ëŒ€ë¬¸ìë¡œ ë³€ê²½                                                | UPPER('abc') = 'ABC'            |
| LENGTH(ë¬¸ì)                                               | ë¬¸ì ê¸¸ì´                                                    | LENGTH('ABC') = 3               |
| LOCATE(ì°¾ì„ ë¬¸ì, ì›ë³¸ ë¬¸ì, [ê²€ìƒ‰ì‹œì‘ìœ„ì¹˜\])              | ê²€ìƒ‰ìœ„ì¹˜ë¶€í„° ë¬¸ìë¥¼ ê²€ìƒ‰ 1ë¶€í„° ì‹œì‘, ëª» ì°¾ìœ¼ë©´ 0 ë°˜í™˜        | LOCATE('DE', 'ABCDEFG') = 4     |

#### ìˆ˜í•™í•¨ìˆ˜

| í•¨ìˆ˜                        | ì„¤ëª…                                                         | ì˜ˆì œ                           |
| :-------------------------- | :----------------------------------------------------------- | :----------------------------- |
| ABS(ìˆ˜í•™ì‹)                 | ì ˆëŒ€ê°’ì„ êµ¬í•œë‹¤.                                             | ABS(-10) = 10                  |
| SQRT(ìˆ˜í•™ì‹)                | ì œê³±ê·¼ì„ êµ¬í•œë‹¤.                                             | SQRT(4) = 2.0                  |
| MOD(ìˆ˜í•™ì‹, ë‚˜ëˆŒ ìˆ˜)        | ë‚˜ë¨¸ì§€ë¥¼ êµ¬í•œë‹¤.                                             | MOD(4,3) = 1                   |
| SIZE(ì»¬ë ‰ì…˜ ê°’ ì—°ê´€ ê²½ë¡œì‹) | ì»¬ë ‰ì…˜ì˜ í¬ê¸°ë¥¼ êµ¬í•œë‹¤.                                      | SIZE(t.members)                |
| INDEX(ë³„ì¹­)                 | LIST íƒ€ì… ì»¬ë ‰ì…˜ì˜ ìœ„ì¹˜ê°’ì„ êµ¬í•¨ ì»¬ë ‰ì…˜ì´ @OrderColumnì„ ì‚¬ìš©í•˜ëŠ” LIST íƒ€ì…ì¼ ë•Œ ì‚¬ìš© ê°€ëŠ¥ | t.members m where INDEX(m) > 3 |

- ë‚ ì§œ í•¨ìˆ˜

  - CURRENT_DATE: í˜„ì¬ ë‚ ì§œ

  - CURRENT_TIME: í˜„ì¬ ì‹œê°„

  - CURRENT_TIMESTAMP: í˜„ì¬ ë‚ ì§œ ì‹œê°„

  ```
  select CURRENT_DATE, CURRENT_TIME, CURRENT_TIMESTAMP from Team t
  //ê²°ê³¼ 2013-08-19, 23:38:17, 2013-08-19 23:38:17.736
  ```

  - í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” ë‚ ì§œ íƒ€ì…ì— ë…„, ì›”, ì¼, ì‹œê°„, ë¶„, ì´ˆ ê¸°ëŠ¥ ì§€ì›
    - YEAR, MONTH, DAY, HOUR, MINUTE, SECOND



#### CASE ì‹

íŠ¹ì • ì¡°ê±´ì— ë”°ë¼ ë¶„ê¸° í•  ë•Œ CASE ì‹ì„ ì‚¬ìš©

- ê¸°ë³¸ CASE

  ```
  //ë¬¸ë²•
  CASE
  	{WHEN <ì¡°ê±´ì‹> THEN <ìŠ¤ì¹¼ë¼ì‹>} +
  	ELSE <ìŠ¤ì¹¼ë¼ì‹>
  END
  
  //JPQL ì˜ˆì‹œ
  select 
  	case 
  		when m.age <= 10 then 'í•™ìƒìš”ê¸ˆ'
  		when m.age >= 60 then 'ê²½ë¡œìš”ê¸ˆ'
  		else 'ì¼ë°˜ìš”ê¸ˆ'
  	end
  from Member m
  ```



- ì‹¬í”Œ CASE

  - ì¡°ê±´ì‹ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ì§€ë§Œ, ë¬¸ë²•ì´ ë‹¨ìˆœ
  - ìë°”ì˜ switch case ë¬¸ê³¼ ë¹„ìŠ·

  ```
  //ë¬¸ë²•
  CASE <ì¡°ê±´ëŒ€ìƒ>
  	{WHEN <ìŠ¤ì¹¼ë¼ì‹1> THEN <ìŠ¤ì¹¼ë¼ì‹2>} +
  	ELSE <ìŠ¤ì¹¼ë¼ì‹>
  END
  
  //JPQL ì˜ˆì‹œ
  select 
  	case t.name
  		when 'íŒ€A' then 'ì¸ì„¼í‹°ë¸Œ110%'
  		when 'íŒ€B' then 'ì¸ì„¼í‹°ë¸Œ120%'
  		else 'ì¸ì„¼í‹°ë¸Œ105%'
  	end
  from Team t
  ```



- COALESCE

  - ìŠ¤ì¹¼ë¼ì‹ì„ ì°¨ë¡€ëŒ€ë¡œ ì¡°íšŒí•´ì„œ nullì´ ì•„ë‹ˆë©´ ë°˜í™˜

  ```
  //ë¬¸ë²•
  COALESCE (<ìŠ¤ì¹¼ë¼ì‹> {,<ìŠ¤ì¹¼ë¼ì‹>}+)
  
  //ì˜ˆì‹œ: m.usernameì´ nullì´ë©´ 'ì´ë¦„ ì—†ëŠ” íšŒì›'ì„ ë°˜í™˜
  select coalesce(m.username, 'ì´ë¦„ ì—†ëŠ” íšŒì›') from Member m
  ```



- NULLIF

  - **ë‘ ê°’ì´ ê°™ìœ¼ë©´ nullì„ ë°˜í™˜í•˜ê³  ë‹¤ë¥´ë©´ ì²«ë²ˆ ì§¸ ê°’ì„ ë°˜í™˜** ì§‘í•© í•¨ìˆ˜ëŠ” nullì„ í¬í•¨í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ **ë³´í†µ ì§‘í•© í•¨ìˆ˜ì™€ í•¨ê»˜ ì‚¬ìš©**

  ```
  //ë¬¸ë²•
  NULLIF(<ìŠ¤ì¹¼ë¼ì‹>, <ìŠ¤ì¹¼ë¼ì‹>)
  
  //ì˜ˆì‹œ : ì‚¬ìš©ì ì´ë¦„ì´ 'ê´€ë¦¬ì'ë©´ null ë°˜í™˜, ë‚˜ë¨¸ì§€ëŠ” ë³¸ì¸ ì´ë¦„ ì¶œë ¥
  select NULLIF(m.username, 'ê´€ë¦¬ì') from Member m
  ```

----

### ë‹¤í˜•ì„± ì¿¼ë¦¬

> JPQLë¡œ ë¶€ëª¨ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ë©´ ìì‹ ì—”í‹°í‹°ë„ í•¨ê»˜ ì¡°íšŒ

```java
@Entity
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
@DiscriminatorColumn(name = "DTYPE")
public abstract class Item {...}

@Entity 
@DiscriminatorValue("B")
public class Book extends Item {
		...
		private String author;
}

//Album, Movie ìƒëµ
```



#### ë¶€ëª¨ ì¡°íšŒ

```
List resultList = em.createQuery("select i from Item i").getResultList();
```

- ë‹¨ì¼ í…Œì´ë¸” ì „ëµ(`InheritanceType.SINGLE_TABLE`) ì„ ì‚¬ìš©í•œ ê²½ìš°

  ```
  SELECT * FROM ITEM
  ```

- ì¡°ì¸ ì „ëµ(`InheritanceType.JOINED`)ì„ ì‚¬ìš©í•œ ê²½ìš°

  ```
  SELECT
  		I.ITEM_ID, ...,
  		B.AUTHOR, ...,
  		A.ARTIST, ...,
  		M.ACTOR, ...,
  FROM ITEM I
  LEFT OUTER JOIN
  		BOOK B ON I.ITEM_ID=B.ITEM_ID
  LEFT OUTER JOIN
  		ALBUM A ON I.IOTEM_ID=A.ITEM_ID
  LEFT OUTER JOIN
  		MOVIE M ON I.ITEM_ID=M.ITEM_ID
  ```



#### TYPE

> ì¡°íšŒ ëŒ€ìƒì„ íŠ¹ì • ìì‹ íƒ€ì…ìœ¼ë¡œ í•œì •í•  ë–„ ì£¼ë¡œ ì‚¬ìš©

```
//Item ì¤‘ì— Book, Movieë¥¼ ì¡°íšŒí•˜ë¼

//JPQL
select i from Item i
where type(i) IN (Book, Movie)

//SQL
SELECT I FROM ITEM I
WHERE I.DTYPE IN ('B', 'M')
```



#### TREAT(JPA 2.1)

> ìë°”ì˜ íƒ€ì… ìºìŠ¤íŒ…ê³¼ ë¹„ìŠ·í•œ ê¸°ëŠ¥ 
>
> JPA í‘œì¤€ì€ FROM, WHEREì ˆë§Œ ì‚¬ìš© ê°€ëŠ¥, í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” SELECTì ˆë„ ì‚¬ìš© ê°€ëŠ¥

```
//ë¶€ëª¨ì¸ Itemê³¼ ìì‹ Bookì´ ìˆìŒ

//JPQL
select i from Item i where treat(i as Book).author = 'kim'

//SQL
SELECT I.* FROM ITEM I
WHERE 
		I.DTYPE='B'
		AND I.AUTHOR='kim'
```

----

### ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ í˜¸ì¶œ(JPA 2.1)

```
//ë¬¸ë²•
function_invocation:: = FUNCTION(function_name (, function_args}*)

//JPQL
select function('group_concat', i.name) from Item i
```

- í•˜ì´ë²„ë„¤ì´íŠ¸ êµ¬í˜„ì²´ë¥¼ ì‚¬ìš©í•˜ë©´ ë°©ì–¸ í´ë˜ìŠ¤ ìƒì†ì„ êµ¬í˜„ í›„ í•¨ìˆ˜ ë“±ë¡ì´ í•„ìš”

  ```
  //ë°©ì–¸ í´ë˜ìŠ¤ ìƒì†
  public class MyH2Dialect extends H2Dialect {
  		pulbic MyH2Dialect() {
  				registerFunction("group_concat", new StandardSQLFunction
  						("group_concat", StandardBasicTypes.STRING));
  		}
  }
  
  //hibernate.dialectì— í•´ë‹¹ ë°©ì–¸ì„ ë“±ë¡(persistence.xml)
  <property name="hibernate.dialect" value="hello.MyH2Dialect" />
  
  
  //í•˜ì´ë²„ë„¤ì´íŠ¸ êµ¬í˜„ì²´ ì‚¬ìš©ì‹œ JPQL
  select group_concat(i.name) from Item i
  ```

----

### ê¸°íƒ€ ì •ë¦¬

- enumì€ = ë¹„êµ ì—°ì‚°ë§Œ ì§€ì›

- ì„ë² ë””ë“œ íƒ€ì…ì€ ë¹„êµë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ



#### EMPTY STRING

JPAí‘œì¤€ì€ ''ì„ ê¸¸ì´ 0ì¸ Empty Stringìœ¼ë¡œ ì •ì˜ í•˜ì§€ë§Œ DBì— ë”°ë¼ ''ì„ NULLë¡œ ì‚¬ìš©í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë„ ìˆìœ¼ë¯€ë¡œ í™•ì¸ í•„ìš”



#### NULL ì •ì˜

- ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ë°ì´í„°ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ NULL

- NULLê³¼ì˜ ëª¨ë“  ìˆ˜í•™ì  ê³„ì‚° ê²°ê³¼ëŠ” NULL
  - Null == Null ì€ ì•Œ ìˆ˜ ì—†ëŠ” ê°’
  - Null is Null ì€ ì°¸

| AND  | T    | F    | U    |
| ---- | ---- | ---- | ---- |
| T    | T    | F    | U    |
| F    | F    | F    | F    |
| U    | U    | F    | U    |



| OR   | T    | F    | U    |
| ---- | ---- | ---- | ---- |
| T    | T    | T    | T    |
| F    | T    | F    | U    |
| U    | T    | U    | U    |



| NOT  |      |
| ---- | ---- |
| T    | F    |
| F    | T    |
| U    | U    |

-----

### ì—”í‹°í‹° ì§ì ‘ ì‚¬ìš©

#### ê¸°ë³¸ í‚¤ ê°’

> ê°ì²´ ì¸ìŠ¤í„´ìŠ¤ëŠ” ì°¸ì¡° ê°’ìœ¼ë¡œ ì‹ë³„í•˜ê³  í…Œì´ë¸” ë¡œìš°ëŠ” ê¸°ë³¸ í‚¤ ê°’ìœ¼ë¡œ ì‹ë³„

````
//JPQL
select count(m.id) from Member m //ì—”í‹°í‹°ì˜ ì•„ì´ë””ë¥¼ ì‚¬ìš©
select count(m) from Member m //ì—”í‹°í‹°ë¥¼ ì§ì ‘ ì‚¬ìš©

//ì‹¤í–‰ê²°ê³¼ ë‘ê°œê°€ ë™ì¼
select count(m.id) as cnt
from Member m
````



> ì—”í‹°í‹°ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì‚¬ìš©í•˜ëŠ” ì½”ë“œ

```
//ì—”í‹°í‹°
String qlString = "select m from Member m where m = :member";
List resultList = em.createQuery(qlString)
		.setParameter("member", member)
		.getResultList();

//ì‹ë³„ì ê°’
String qlString = "select m from Member m where m.id = :memberId";
List resultList = em.createQuery(qlString)
		.setParameter("memberId", 4L)
		.getResultList();

//ì‹¤í–‰ëœ SQL
select m.*
from Member m
where m.id=?
```